<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSSN Official - Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --gold-grad: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); --dark-bg: #0f172a; --card-bg: rgba(255, 255, 255, 0.05); }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; transition: 0.3s; }
        body { margin: 0; background: var(--dark-bg); color: white; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 450px; min-height: 100vh; background: var(--dark-bg); position: relative; border: 1px solid rgba(255,255,255,0.1); padding-bottom: 80px; }
        input, select, textarea { width: 100%; padding: 14px; background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; outline: none; margin-bottom: 12px; }
        .btn-premium { width: 100%; padding: 16px; background: var(--gold-grad); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; }
        #dashboard { display: none; }
        .full-page-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 2000; padding: 25px; overflow-y: auto; }
        .tab-content { display: none; padding: 20px; animation: fadeIn 0.4s; }
        .active-tab { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .balance-card { background: var(--card-bg); padding: 25px; border-radius: 20px; text-align: center; margin: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .task-card { background: var(--card-bg); padding: 20px; border-radius: 15px; border: 1px solid #2ecc71; margin-top: 15px; text-align: center; position: relative; }
        .price-badge { position: absolute; top: 10px; right: 10px; background: #2ecc71; color: black; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .instr-box { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; font-size: 12px; text-align: left; margin: 15px 0; border-left: 3px solid #2ecc71; color: #cbd5e1; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 450px; height: 75px; background: #0f172a; display: flex; border-top: 1px solid rgba(255,255,255,0.05); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: #94a3b8; cursor: pointer; }
        .nav-item.active { color: #2ecc71; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="auth-screen" style="padding:40px 25px; text-align:center;">
        <h2 style="color:#2ecc71;">PSSN OFFICIAL</h2>
        <div id="register-form">
            <input type="text" id="r-name" placeholder="Full Name">
            <input type="number" id="r-phone" placeholder="WhatsApp Number">
            <input type="password" id="r-pass" placeholder="Password">
            <input type="text" id="r-ref" placeholder="Referral Code">
            <button class="btn-premium" id="reg-btn" onclick="enterApp('reg')">REGISTER</button>
            <p onclick="toggleAuth(true)" style="font-size:13px; cursor:pointer;">Already have an account? Login</p>
        </div>
        <div id="login-form" style="display:none;">
            <input type="number" id="l-phone" placeholder="WhatsApp Number">
            <input type="password" id="l-pass" placeholder="Password">
            <button class="btn-premium" id="login-btn" onclick="enterApp('login')">LOGIN</button>
            <p onclick="toggleAuth(false)" style="font-size:13px; cursor:pointer;">New member? Register</p>
        </div>
    </div>

    <div id="dashboard">
        <div id="announcement-area" style="background:#2ecc7111; color:#2ecc71; padding:10px; text-align:center; font-size:12px; margin:10px;">Welcome to PSSN!</div>

        <div class="balance-card">
            <span style="font-size:11px;">TOTAL BALANCE</span>
            <h1 id="main-bal" style="color:#2ecc71; margin:5px 0;">Rs. 0.00</h1>
        </div>

        <div id="tab-home" class="tab-content active-tab">
            <img id="home-banner" src="https://i.ibb.co/LhbV4Vb/FB-IMG-1768455528784.jpg" style="width:100%; border-radius:15px;">
            <div id="task-container"></div>
        </div>

        <div id="tab-about" class="tab-content">
            <h3>Instructions</h3>
            <div style="background:var(--card-bg); padding:15px; border-radius:12px; font-size:13px; color:#cbd5e1;">
                Complete tasks, upload screenshots, and earn daily. Min withdraw Rs. 300.
            </div>
            <a href="https://whatsapp.com/channel/0029VbBtlLd29752E8E2z10W" class="btn-premium" style="background:#25d366; margin-top:15px;">WhatsApp Channel</a>
        </div>

        <div id="tab-team" class="tab-content">
            <h3>My Team</h3>
            <div id="ref-link" style="padding:10px; border:1px dashed #2ecc71; font-size:10px; margin-bottom:10px;">Generating...</div>
            <button class="btn-premium" onclick="copyRef()">COPY REFERRAL LINK</button>
            <div style="text-align:center; margin-top:15px;">Team Size: <b id="team-count" style="color:#2ecc71;">0</b></div>
            <a href="https://wa.me/923000000000" class="btn-premium" style="background:#25d366; margin-top:20px;">Contact Support</a>
        </div>

        <div id="tab-wallet" class="tab-content">
            <h3 onclick="checkAdminAccess()" style="cursor:pointer;">Wallet Binding</h3>
            <div id="bind-section">
                <input type="text" id="acc-name-val" placeholder="Account Name">
                <select id="acc-type-val"><option>EasyPaisa</option><option>JazzCash</option></select>
                <input type="number" id="acc-num-val" placeholder="Account Number">
                <button class="btn-premium" onclick="bindAccount()">BIND WALLET</button>
            </div>
            <div id="saved-acc-display" style="display:none;">
                <div id="acc-details-text" style="background:rgba(46,204,113,0.1); padding:15px; border-radius:12px; color:#2ecc71;">-</div>
                <input type="number" id="withdraw-amt" placeholder="Amount (Min 300)" style="margin-top:20px;">
                <button class="btn-premium" onclick="requestWithdrawal()">SUBMIT WITHDRAW</button>
            </div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="navTo('tab-home', this)">üè†<span>Home</span></div>
            <div class="nav-item" onclick="navTo('tab-about', this)">‚ÑπÔ∏è<span>About</span></div>
            <div class="nav-item" onclick="navTo('tab-team', this)">üë•<span>Team</span></div>
            <div class="nav-item" onclick="navTo('tab-wallet', this)">üí∞<span>Wallet</span></div>
        </nav>
    </div>

    <div id="admin-panel" class="full-page-overlay">
        <h3>Admin Tools</h3>
        <input type="text" id="adm-news" placeholder="Home News Text">
        <input type="text" id="adm-banner" placeholder="Home Banner URL">
        <hr>
        <input type="text" id="adm-title" placeholder="Task Name">
        <input type="text" id="adm-price" placeholder="Task Reward">
        <textarea id="adm-desc" placeholder="Task Description"></textarea>
        <input type="text" id="adm-link" placeholder="Task Link">
        <button class="btn-premium" onclick="saveAdminSettings()">POST SETTINGS</button>
        <button onclick="closeOverlay('admin-panel')" style="color:white; border:none; background:none; width:100%;">Close</button>
    </div>

    <div id="task-submission-page" class="full-page-overlay">
        <h3 id="sub-task-name">Proof Upload</h3>
        <input type="file" id="proof-file" accept="image/*">
        <input type="text" id="proof-comment" placeholder="Your Handle/Username">
        <button id="submit-proof-btn" class="btn-premium" onclick="uploadAndSubmit()">SUBMIT PROOF</button>
        <button onclick="closeOverlay('task-submission-page')" style="color:white; border:none; background:none; width:100%;">Cancel</button>
    </div>
</div>

<script>
    let currentUserPhone = "";
    const SHEETDB_URL = "https://sheetdb.io/api/v1/h0yk6frxj1bdg";
    const IMGBB_API_KEY = "7d44869894e6378e906c6463406283b7";

    function toggleAuth(isLogin) {
        document.getElementById('register-form').style.display = isLogin ? "none" : "block";
        document.getElementById('login-form').style.display = isLogin ? "block" : "none";
    }

    async function enterApp(type) {
        const phone = (type==='reg')?document.getElementById('r-phone').value : document.getElementById('l-phone').value;
        const pass = (type==='reg')?document.getElementById('r-pass').value : document.getElementById('l-pass').value;
        const btn = (type==='reg')?document.getElementById('reg-btn') : document.getElementById('login-btn');
        if(!phone || !pass) return alert("Please fill all fields!");
        
        btn.disabled = true; btn.innerText = "Processing...";

        try {
            const res = await fetch(`${SHEETDB_URL}/search?phone=${phone}`);
            const data = await res.json();
            
            if(type==='reg') {
                if(data.length > 0) { alert("Phone already registered!"); btn.disabled = false; return; }
                const refBy = document.getElementById('r-ref').value || "DIRECT";
                const newUser = { phone: phone, password: pass, acc_name: document.getElementById('r-name').value, balance: "0", type_action: "REGISTRATION", date: new Date().toLocaleString(), status: refBy };
                await fetch(SHEETDB_URL, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({data:[newUser]}) });
            } else {
                if(data.length === 0 || data[0].password !== pass) { alert("Wrong Password/Phone!"); btn.disabled = false; return; }
            }

            currentUserPhone = phone;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('ref-link').innerText = window.location.href.split('?')[0] + "?ref=" + phone;
            fetchUserData();
        } catch(e) { alert("Connection Error!"); }
        btn.disabled = false; btn.innerText = (type==='reg')?"REGISTER":"LOGIN";
    }

    async function fetchUserData() {
        if(!currentUserPhone) return;
        const res = await fetch(`${SHEETDB_URL}/search?phone=${currentUserPhone}`);
        const data = await res.json();
        
        const balEntry = data.find(i => i.type_action === "REGISTRATION");
        if(balEntry) document.getElementById('main-bal').innerText = "Rs. " + (balEntry.balance || "0.00");
        
        const bnd = data.find(i => i.type_action === "ACCOUNT_BIND");
        if(bnd) {
            document.getElementById('bind-section').style.display = 'none';
            document.getElementById('saved-acc-display').style.display = 'block';
            document.getElementById('acc-details-text').innerText = `${bnd.acc_type}: ${bnd.acc_num}`;
        }

        const teamRes = await fetch(`${SHEETDB_URL}/search?status=${currentUserPhone}`);
        const teamData = await teamRes.json();
        document.getElementById('team-count').innerText = teamData.length;

        const admRes = await fetch(`${SHEETDB_URL}/search?type_action=ADMIN_SETTING`);
        const setts = await admRes.json();
        if(setts.length > 0) {
            const last = setts[setts.length-1];
            document.getElementById('announcement-area').innerText = last.status;
            document.getElementById('home-banner').src = last.acc_name;
        }

        const taskRes = await fetch(`${SHEETDB_URL}/search?type_action=TASK_POST`);
        const tasks = await taskRes.json();
        const container = document.getElementById('task-container');
        container.innerHTML = "";
        tasks.reverse().forEach(t => {
            const card = document.createElement('div'); card.className="task-card";
            card.innerHTML = `<span class="price-badge">Rs. ${t.date}</span><h3>${t.status}</h3><div class="instr-box">${t.withdraw_amount}</div><button class="btn-premium" onclick="window.open('${t.acc_num}')">GO TO TASK</button><button class="btn-premium" style="background:none; border:1px solid #2ecc71; color:#2ecc71;" onclick="openTaskSubmission('${t.status}')">SUBMIT PROOF</button>`;
            container.appendChild(card);
        });
    }

    async function bindAccount() {
        const d = { phone: currentUserPhone, acc_name: document.getElementById('acc-name-val').value, acc_type: document.getElementById('acc-type-val').value, acc_num: document.getElementById('acc-num-val').value, type_action: "ACCOUNT_BIND" };
        await fetch(SHEETDB_URL, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({data:[d]}) });
        alert("Wallet Bound!"); fetchUserData();
    }

    async function requestWithdrawal() {
        const amt = document.getElementById('withdraw-amt').value;
        if(amt < 300) return alert("Minimum Rs. 300 required!");
        const d = { phone: currentUserPhone, withdraw_amount: amt, status: "Pending", type_action: "WITHDRAWAL", date: new Date().toLocaleString() };
        await fetch(SHEETDB_URL, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({data:[d]}) });
        alert("Withdrawal Requested!");
    }

    function navTo(id, el) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active-tab'); el.classList.add('active');
        fetchUserData();
    }

    function copyRef() { navigator.clipboard.writeText(document.getElementById('ref-link').innerText); alert("Referral Link Copied!"); }
    function checkAdminAccess() { if(prompt("Enter Admin PIN:") === "Hussain@2025") document.getElementById('admin-panel').style.display = 'block'; }
    function closeOverlay(id) { document.getElementById(id).style.display = 'none'; }
    function openTaskSubmission(t) { document.getElementById('sub-task-name').innerText = t; document.getElementById('task-submission-page').style.display = 'block'; }

    async function uploadAndSubmit() {
        const file = document.getElementById('proof-file').files[0];
        if(!file) return alert("Select Screenshot!");
        const btn = document.getElementById('submit-proof-btn');
        btn.innerText = "Uploading Pic..."; btn.disabled = true;
        
        try {
            const fd = new FormData(); fd.append("image", file);
            const imgRes = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: fd });
            const imgData = await imgRes.json();
            
            const sub = { phone: currentUserPhone, status: "Pending", type_action: "TASK_SUBMISSION", acc_name: document.getElementById('sub-task-name').innerText, acc_num: imgData.data.url, date: document.getElementById('proof-comment').value };
            await fetch(SHEETDB_URL, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({data:[sub]}) });
            
            alert("Proof Submitted!"); closeOverlay('task-submission-page');
        } catch(e) { alert("Upload Failed!"); }
        btn.innerText = "SUBMIT PROOF"; btn.disabled = false;
    }

    async function saveAdminSettings() {
        const news = { phone: "ADMIN_NEWS", acc_name: document.getElementById('adm-banner').value, status: document.getElementById('adm-news').value, type_action: "ADMIN_SETTING" };
        const task = { phone: "ADMIN", status: document.getElementById('adm-title').value, withdraw_amount: document.getElementById('adm-desc').value, acc_num: document.getElementById('adm-link').value, date: document.getElementById('adm-price').value, type_action: "TASK_POST" };
        await fetch(SHEETDB_URL, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({data:[news, task]}) });
        alert("Settings Updated!"); closeOverlay('admin-panel'); fetchUserData();
    }
</script>
</body>
</html>
